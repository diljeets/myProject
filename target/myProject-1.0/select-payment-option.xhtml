<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:head>
        <title>Select Payment Option</title>
    </h:head>
    <h:body>
        <ui:composition template="./template.xhtml">
            <ui:define name="top"></ui:define>
            <ui:define name="content"> 
                <div class="p-grid p-justify-center">
                    <div class="p-col-12 p-md-10 p-lg-9 p-xl-9">
                        <h3>Select Payment Method</h3>
                        <h:form id="form-payment-options">    
                            <p:messages id="messages" showDetail="true" closable="true" showSummary="false">
                                <p:autoUpdate/>
                            </p:messages> 
                            <p>             
                                <p:dataTable id="datatable-paymentoptions"
                                             class="table-paymentoptions"                                    
                                             value="#{checkoutController.paymentOptions}"        
                                             var="paymentOption"
                                             selection="#{checkoutController.paymentOption}"
                                             rowKey="#{paymentOption.paymentMode}"
                                             rendered="#{checkoutController.paymentOptions.size() > 0}"
                                             summary="List of Payment Methods">  
                                    <p:ajax event="rowSelectRadio" listener="#{checkoutController.onRowSelectPaymentOption}" process="@this,paytm,creditcard,debitcard,netbanking" update="@this,paytm,creditcard,debitcard,netbanking"/>
                                    <p:ajax event="rowSelect" listener="#{checkoutController.onRowSelectPaymentOption}" process="@this,paytm,creditcard,debitcard,netbanking" update="@this,paytm,creditcard,debitcard,netbanking"/>                          
                                    <p:column selectionMode="single"/>                              
                                    <p:column>
                                        <h:outputText value="#{paymentOption.displayName}"/>      

                                        <p:panel id="paytm" 
                                                 rendered="#{checkoutController.isModePaytm}"
                                                 style="border:none;"> 
                                            <p:panel rendered="#{paymentOption.paymentMode eq 'BALANCE'}" style="border:none;">

                                                <p:panel id="panelSendOtp" widgetVar="panelSendOtp">
                                                    <h:form id="paytmForm">
                                                        <div class="ui-fluid p-formgrid p-grid p-mt-4">
                                                            <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                                <p:outputLabel for="paytm-mobile" value="Paytm Mobile"/>
                                                                <span class="ui-fluid p-formgrid p-grid p-mt-2">
                                                                    <span class="p-field p-col-12">
                                                                        <div class="ui-inputgroup">
                                                                            <span class="ui-inputgroup-addon">+91</span>
                                                                            <p:inputText id="paytm-mobile" value="#{checkoutController.paytmMobile}" maxlength="10" placeholder="Enter Mobile No." validator="#{checkoutController.validatePaytmMobileNumber}">
                                                                                <p:ajax/>
                                                                            </p:inputText>

                                                                        </div>
                                                                    </span>
                                                                    <span class="p-field p-col-12">
                                                                        <p:commandButton value="Send OTP" actionListener="#{checkoutController.sendOTP(checkoutController.paytmMobile)}" onclick="PF('progressPanel').show();PF('sendOtpBtn').disable();" oncomplete="PF('progressPanel').close();PF('sendOtpBtn').enable();PF('panelEnterOtp').show();PF('panelSendOtp').close();" process="paytmForm" update="paytmForm" widgetVar="sendOtpBtn"/>
                                                                    </span>
                                                                </span>
                                                            </span>                                                        
                                                        </div>    
                                                    </h:form>
                                                </p:panel> 

                                                <p:panel id="panelEnterOtp" visible="false" widgetVar="panelEnterOtp">
                                                    <div class="ui-fluid p-formgrid p-grid p-mt-4">
                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                            <p:outputLabel for="enter-otp" value="Enter OTP"/>
                                                            <span class="ui-fluid p-formgrid p-grid p-mt-2">
                                                                <span class="p-field p-col-12">
                                                                    <p:inputText class="otpInputText" id="enter-otp" value="#{checkoutController.otp}" maxlength="6"/>    

                                                                </span>
                                                                <span class="p-field p-col-12">
                                                                    <p:commandButton value="Submit" actionListener="#{checkoutController.validateOtpAndFetchPaytmBalance(checkoutController.otp)}" onclick="PF('progressPanel').show();PF('enterOtpBtn').disable();" oncomplete="PF('progressPanel').close();PF('enterOtpBtn').enable();" onsuccess="PF('panelEnterOtp').close();PF('panelPaytmBalance').show();" widgetVar="enterOtpBtn" update="panelPayChannelOptionPaytmBalance"/>
                                                                </span>
                                                            </span>
                                                        </span>
                                                    </div>                                                                
                                                </p:panel>
                                                <p:panel visible="false" widgetVar="panelPaytmBalance">
                                                    <div class="ui-fluid p-formgrid p-grid p-mt-4">
                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-12">
                                                            <p:panel id="panelPayChannelOptionPaytmBalance">
                                                                <p:repeat value="#{checkoutController.payChannelOptionsPaytmBalance}" var="payChannelOptionPaytmBalance">
                                                                    <p:panel rendered="#{payChannelOptionPaytmBalance.displayName eq 'Paytm Wallet'}">
                                                                        <span class="p-grid p-align-center">
                                                                            <p:graphicImage url="#{payChannelOptionPaytmBalance.imageUrl}" width="50px" height="50px"/>
                                                                            <h:outputText styleClass="p-ml-2" value="#{payChannelOptionPaytmBalance.displayName} #{payChannelOptionPaytmBalance.balance}"/>                                      
                                                                        </span>
                                                                    </p:panel>
                                                                </p:repeat>
                                                            </p:panel>     
                                                        </span>
                                                    </div>                                                      
                                                </p:panel> 
                                                <!--                                                </h:form>-->
                                            </p:panel>                                 
                                        </p:panel>

                                        <p:panel id="creditcard" 
                                                 rendered="#{checkoutController.isModeCC}"
                                                 style="border:none;">
                                            <p:panel rendered="#{paymentOption.paymentMode eq 'CREDIT_CARD'}" style="border:none;">  
                                                <h:form>
                                                    <p:panel visible="false" widgetVar="panelCCDetails">
                                                        <div class="p-grid">
                                                            <div class="p-col-12 p-mt-3 p-pb-0">
                                                                <h:outputText class="p-mr-2" id="ccIssuingBank" value="#{checkoutController.issuingBank}"/>

                                                            </div>
                                                        </div>
                                                    </p:panel>
                                                    <div class="ui-fluid p-formgrid p-grid p-mt-3">
                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                            <p:outputLabel for="ccNumber" value="Credit Card Number"/>
                                                            <span class="ui-fluid p-formgrid p-grid p-mt-1">
                                                                <span class="p-field p-col-12 p-sm-12 p-md-12 p-lg-12 p-xl-12"> 
                                                                    <p:inputText id="ccNumber" value="#{checkoutController.ccNumber}" maxlength="16" required="true" requiredMessage="Please enter Credit Card Number" validator="#{checkoutController.validateCardNumber}" placeholder="16-digit Card Number">

                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>      -->                                                                        
                                                                        <p:ajax event="blur" listener="#{checkoutController.fetchBinDetails}" oncomplete="PF('panelCCDetails').show();" process="@this,ccIcon,ccIssuingBank" update="ccIcon,ccIssuingBank"/>
                                                                    </p:inputText>
                                                                    <p:graphicImage class="cardIcon" id="ccIcon" value="#{checkoutController.cardIconUrl}"/>
                                                                </span>
                                                            </span>
                                                        </span>

                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                            <p:outputLabel for="ccExpiryMonth" value="Expiry Date"/> 
                                                            <span class="ui-fluid p-formgrid p-grid p-align-center p-mt-1">  
                                                                <span class="p-field p-col-5 p-sm-5 p-md-4 p-lg-5 p-xl-5">
                                                                    <p:inputText id="ccExpiryMonth" value="#{checkoutController.ccExpiryMonth}" maxlength="2" required="true" requiredMessage="Please enter Card Expiry Month" validator="#{checkoutController.validateExpiryMonth}" placeholder="e.g 01">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>-->
                                                                        <p:ajax/> 
                                                                    </p:inputText>
                                                                </span>
                                                                <span class="p-field p-col-2 p-sm-1 p-md-1 p-lg-1 p-xl-1 p-text-center">
                                                                    <ui:fragment>/</ui:fragment>
                                                                </span>
                                                                <span class="p-field p-col-5 p-sm-5 p-md-4 p-lg-6 p-xl-6">
                                                                    <p:inputText id="ccExpiryYear" value="#{checkoutController.ccExpiryYear}" maxlength="4" required="true" requiredMessage="Please enter Card Expiry Year" validator="#{checkoutController.validateExpiryYear}" placeholder="e.g 2050">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/> -->
                                                                        <p:ajax/> 
                                                                    </p:inputText>
                                                                </span>
                                                            </span>                                                        
                                                        </span>

                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-4">
                                                            <p:outputLabel for="ccCvv" value="Cvv"/>  
                                                            <span class="ui-fluid p-formgrid p-grid p-mt-1">  
                                                                <span class="p-field p-col-12 p-sm-5 p-md-4 p-lg-5 p-xl-4">
                                                                    <p:password id="ccCvv" value="#{checkoutController.ccCvv}" maxlength="3" required="true" requiredMessage="Please enter Card CVV number" validator="#{checkoutController.validateCvv}" placeholder="e.g 123">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>-->
                                                                        <p:ajax/>                                                                  
                                                                    </p:password>
                                                                </span>
                                                            </span>
                                                        </span> 
                                                        <span class="p-col-12 p-md-12 p-lg-12">
                                                            <span class="p-grid p-m-0 p-align-center">
                                                                <p:graphicImage name="visa.png" library="images"/>
                                                                <p:graphicImage name="mastercard.png" library="images"/>
                                                                <p:graphicImage name="maestro.png" library="images"/>
                                                                <p:graphicImage name="amex.png" library="images"/> 
                                                            </span>
                                                        </span>
                                                    </div>
                                                </h:form>
                                            </p:panel>                                                                    
                                        </p:panel>


                                        <p:panel id="debitcard" 
                                                 rendered="#{checkoutController.isModeDC}"
                                                 style="border:none;">
                                            <p:panel rendered="#{paymentOption.paymentMode eq 'DEBIT_CARD'}" style="border:none;">
                                                <h:form>
                                                    <p:panel visible="false" widgetVar="panelDCDetails">
                                                        <div class="p-grid">
                                                            <div class="p-col-12 p-mt-3 p-pb-0">
                                                                <h:outputText class="p-mr-2" id="dcIssuingBank" value="#{checkoutController.issuingBank}"/>
                                                            </div>
                                                        </div>
                                                    </p:panel>
                                                    <div class="ui-fluid p-formgrid p-grid p-mt-3">
                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                            <p:outputLabel for="dcNumber" value="Debit Card Number"/>
                                                            <span class="ui-fluid p-formgrid p-grid p-mt-1">
                                                                <span class="p-field p-col-12 p-sm-12 p-md-12 p-lg-12 p-xl-12">
                                                                    <p:inputText id="dcNumber" value="#{checkoutController.dcNumber}" maxlength="16" required="true" requiredMessage="Please enter Debit Card Number" validator="#{checkoutController.validateCardNumber}" placeholder="16-digit Card Number">

                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>      -->                                                                        
                                                                        <p:ajax event="blur" listener="#{checkoutController.fetchBinDetails}" oncomplete="PF('panelDCDetails').show();"  process="@this,dcIcon,dcIssuingBank" update="dcIcon,dcIssuingBank"/>
                                                                    </p:inputText>
                                                                    <p:graphicImage class="cardIcon" id="dcIcon" value="#{checkoutController.cardIconUrl}"/>
                                                                </span>
                                                            </span>
                                                        </span>

                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-3">
                                                            <p:outputLabel for="dcExpiryMonth" value="Expiry Date"/> 
                                                            <span class="ui-fluid p-formgrid p-grid p-align-center p-mt-1">  
                                                                <span class="p-field p-col-5 p-sm-5 p-md-4 p-lg-5 p-xl-5">
                                                                    <p:inputText id="dcExpiryMonth" value="#{checkoutController.dcExpiryMonth}" maxlength="2" required="true" requiredMessage="Please enter Card Expiry Month" validator="#{checkoutController.validateExpiryMonth}" placeholder="e.g 01">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>-->
                                                                        <p:ajax/> 
                                                                    </p:inputText>
                                                                </span>
                                                                <span class="p-field p-col-2 p-sm-1 p-md-1 p-lg-1 p-xl-1 p-text-center">
                                                                    <ui:fragment>/</ui:fragment>
                                                                </span>
                                                                <span class="p-field p-col-5 p-sm-5 p-md-4 p-lg-6 p-xl-6">
                                                                    <p:inputText id="dcExpiryYear" value="#{checkoutController.dcExpiryYear}" maxlength="4" required="true" requiredMessage="Please enter Card Expiry Year" validator="#{checkoutController.validateExpiryYear}" placeholder="e.g 2050">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/> -->
                                                                        <p:ajax/> 
                                                                    </p:inputText>
                                                                </span>
                                                            </span>                                                        
                                                        </span>

                                                        <span class="p-col-12 p-sm-6 p-md-6 p-lg-4 p-xl-4">
                                                            <p:outputLabel for="dcCvv" value="Cvv"/>  
                                                            <span class="ui-fluid p-formgrid p-grid p-mt-1">  
                                                                <span class="p-field p-col-12 p-sm-5 p-md-4 p-lg-5 p-xl-4">
                                                                    <p:password id="dcCvv" value="#{checkoutController.dcCvv}" maxlength="3" required="true" requiredMessage="Please enter Card CVV number" validator="#{checkoutController.validateCvv}" placeholder="e.g 123">
                                                                        <!--                                                                        <f:validateRegex pattern="[0-9]+"/>-->
                                                                        <p:ajax/>                                                                  
                                                                    </p:password>
                                                                </span>
                                                            </span>
                                                        </span> 

                                                        <span class="p-col-12 p-md-12 p-lg-12">
                                                            <span class="p-grid p-m-0 p-align-center">
                                                                <p:graphicImage name="visa.png" library="images"/>
                                                                <p:graphicImage name="mastercard.png" library="images"/>
                                                                <p:graphicImage name="maestro.png" library="images"/>
                                                                <p:graphicImage name="amex.png" library="images"/> 
                                                            </span>
                                                        </span>
                                                    </div>
                                                </h:form>
                                            </p:panel>                                     
                                        </p:panel>

                                        <p:panel id="netbanking" 
                                                 rendered="#{checkoutController.isModeNB}"
                                                 style="border:none;">
                                            <p:panel rendered="#{paymentOption.paymentMode eq 'NET_BANKING'}" style="border:none;"> 
                                                <p:dataTable id="datatable-channeloptions"
                                                             class="table-channeloptions"
                                                             value="#{checkoutController.payChannelOptionsNetBanking}"        
                                                             var="payChannelOptionNetBanking"
                                                             selectionMode="single"
                                                             selection="#{checkoutController.payChannelOptionNetBanking}"
                                                             rowKey="#{payChannelOptionNetBanking.channelCode}">
                                                    <p:ajax event="rowSelect" listener="#{checkoutController.onRowSelectPayChannelOptionNetBanking}" update="datatable-channeloptions"/>                            
                                                    <p:column>
                                                        <i class="pi pi-check"></i>  
                                                    </p:column>
                                                    <p:column>
                                                        <ui:fragment rendered="${payChannelOptionNetBanking.channelCode ne 'OTHERS'}">
                                                            <p:graphicImage url="#{payChannelOptionNetBanking.iconUrl}"/>
                                                        </ui:fragment>
                                                        <ui:fragment rendered="${payChannelOptionNetBanking.channelCode eq 'OTHERS'}">
                                                            <i class="pi pi-ellipsis-v"></i> 
                                                        </ui:fragment> 
                                                    </p:column>
                                                    <p:column>
                                                        <h:outputText value="#{payChannelOptionNetBanking.channelName}"/>                                
                                                    </p:column>  
                                                </p:dataTable>
                                            </p:panel>
                                        </p:panel>
                                    </p:column>
                                    <f:facet name="footer"> 
                                        <div class="reviewAndPlaceOrderBtn">
                                            <p:commandButton actionListener="#{checkoutController.processTransaction(checkoutController.paymentMode)}" value="Review and Place Order" onclick="PF('progressPanel').show();PF('reviewAndPlaceOrderBtn').disable();" oncomplete="PF('progressPanel').close();PF('reviewAndPlaceOrderBtn').enable();" widgetVar="reviewAndPlaceOrderBtn"/>
                                        </div>
                                    </f:facet>                                           
                                </p:dataTable>
                            </p>                       
                        </h:form>   
                    </div>
                </div>
                <h:outputStylesheet library="css" name="payment-gateway.css"/>
            </ui:define>
        </ui:composition>        
    </h:body>
</html>

